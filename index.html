<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Mastery Hub - Learn German Effectively</title>
    <meta name="description" content="Master German through articles, podcasts, and interactive exercises">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --success: #22c55e;
            --background: #f1f5f9;
            --surface: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.05);
            --modal-overlay-color: rgba(0, 0, 0, 0.6);

            /* Grammar colors */
            --noun-m: #2563eb;
            --noun-f: #ec4899;
            --noun-n: #10b981;
            --verb: #8b5cf6;
            --adjective: #f59e0b;
            --adverb: #06b6d4;
            --preposition: #f43f5e;
            --conjunction: #14b8a6;
            --pronoun: #eab308;
            --article: #a855f7;
            --punctuation: #64748b;
        }

        body.dark-theme {
            --background: #0f172a;
            --surface: #1e293b;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: rgba(0,0,0,0.2);
            --modal-overlay-color: rgba(0, 0, 0, 0.7);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; line-height: 1.6; color: var(--text); background-color: var(--background); transition: background-color 0.3s ease, color 0.3s ease; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; padding: 20px; background: var(--surface); border-radius: 10px; box-shadow: 0 2px 10px var(--shadow); border: 1px solid var(--border); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        header h1 { color: var(--primary); font-size: 2.2em; }
        header p { color: var(--text-secondary); font-size: 1.1em; }
        #settings-btn { background: transparent; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); transition: transform 0.3s ease; }
        #settings-btn:hover { transform: rotate(45deg); }

        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-tab { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }
        
        .page { display: none; }
        .page.active { display: block; }

        .card { background: var(--surface); padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px var(--shadow); margin-bottom: 20px; border: 1px solid var(--border); }
        .card h2 { color: var(--primary); font-size: 1.8rem; margin-bottom: 20px; }
        .card h3 { color: var(--text); font-size: 1.3rem; margin-bottom: 15px; }

        .german-text { font-size: 1.2rem; line-height: 1.8; margin-bottom: 20px; padding: 20px; background: var(--background); border-left: 4px solid var(--primary); border-radius: 5px; }
        .german-text span { cursor: help; border-bottom: 1px dotted; transition: background-color 0.2s; }
        .german-text span:hover { background-color: rgba(37, 99, 235, 0.1); }
        
        .noun-m { color: var(--noun-m); } .noun-f { color: var(--noun-f); } .noun-n { color: var(--noun-n); }
        .verb { color: var(--verb); } .adjective { color: var(--adjective); } .adverb { color: var(--adverb); }
        .preposition { color: var(--preposition); } .conjunction { color: var(--conjunction); } .pronoun { color: var(--pronoun); } .article { color: var(--article); }
        .punctuation { color: var(--punctuation); border-bottom: none !important; cursor: default !important; }

        .article-section { margin-top: 20px; padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
        .article-section h3 { font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .article-section ul { list-style-position: inside; padding-left: 10px; }
        .article-section li { margin-bottom: 10px; }
        
        .translation-section { background-color: rgba(37, 99, 235, 0.05); }
        .vocabulary-section { background-color: rgba(245, 158, 11, 0.05); }
        .grammar-section { background-color: rgba(16, 185, 129, 0.05); }
        .culture-section { background-color: rgba(236, 72, 153, 0.05); }
        .practice-section { background-color: rgba(139, 92, 246, 0.05); }

        body.dark-theme .article-section { background-color: rgba(255, 255, 255, 0.03); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay-color); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; }
        .modal-close-btn { float: right; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
        .settings-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); }
        .settings-section h3 { font-size: 1.1rem; margin-bottom: 10px; }
        .theme-switch-wrapper, .voice-select-wrapper { display: flex; align-items: center; gap: 10px; }
        
        .conjugation-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; table-layout: fixed; }
        .conjugation-table th, .conjugation-table td { border: 1px solid var(--border); padding: 8px; text-align: left; word-wrap: break-word; }
        .conjugation-table th { background-color: var(--background); }

        .popup-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay-color); z-index: 999; display: none; }
        .word-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--surface); padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; z-index: 1000; display: none; }
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .popup-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); }

        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        
        .drill-item { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .drill-item input { padding: 8px; border: 1px solid var(--border); border-radius: 5px; background: var(--background); color: var(--text); }
        .drill-item .btn { padding: 8px 12px; }
        .drill-result { font-weight: bold; }
        .drill-result.correct { color: var(--success); }
        .drill-result.incorrect { color: var(--danger); }
        .drill-hint { color: var(--text-secondary); font-style: italic; font-size: 0.9em; user-select: none; }

        .level-selector-wrapper { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .level-selector-wrapper label { font-weight: bold; }
        .level-select-dropdown { padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid var(--border); background-color: var(--surface); color: var(--text); cursor: pointer; }
        #article-list-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .article-theme-button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: 1px solid var(--border); background: var(--background); color: var(--text); border-radius: 8px; transition: all 0.3s ease; }
        .article-theme-button:hover { background: var(--primary); color: white; border-color: var(--primary-dark); }

        .color-legend { margin-top: 15px; padding: 15px; border-radius: 8px; background-color: var(--background); }
        .legend-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color-box { width: 18px; height: 18px; border-radius: 4px; }
        
        details.color-legend-details > summary {
            cursor: pointer;
            font-weight: bold;
            color: var(--text-secondary);
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        details.color-legend-details > summary:hover {
            background-color: var(--background);
        }
        details.color-legend-details[open] > summary {
            margin-bottom: 10px;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>üéì German Mastery Hub</h1>
                <button id="settings-btn" title="Settings">‚öôÔ∏è</button>
            </div>
            <p>Learn German effectively through articles, podcasts, and practice</p>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-page="articles">üìñ Articles</button>
            <button class="nav-tab" data-page="podcasts">üéß Podcasts</button>
            <button class="nav-tab" data-page="ai-teacher">üí¨ AI Teacher</button>
            <button class="nav-tab" data-page="grammar">‚úçÔ∏è Grammar Drill</button>
            <button class="nav-tab" data-page="progress">üìä Progress</button>
        </nav>

        <div id="articles" class="page active">
            <div class="card" id="article-selection-card">
                <!-- Content inserted by JS -->
            </div>
            <div id="article-display" class="card" style="display: none;"></div>
        </div>

        <div id="podcasts" class="page"><div class="card"><h2>üéß Podcasts</h2><p>Feature coming soon.</p></div></div>
        <div id="ai-teacher" class="page"><div class="card"><h2>üí¨ AI Teacher</h2><p>Feature coming soon.</p></div></div>
        <div id="grammar" class="page">
            <div class="card">
                <h2>‚úçÔ∏è Grammar Drill</h2>
                <div id="grammar-drill-content"><p>Please select an article first to see its grammar drills.</p></div>
            </div>
        </div>
        <div id="progress" class="page"><div class="card"><h2>üìä Progress</h2><p>Track your learning journey here.</p></div></div>
    </div>

    <div id="word-popup-backdrop" class="popup-backdrop" onclick="closeWordPopup()"></div>
    <div id="word-popup" class="word-popup">
        <div class="popup-header">
            <h3 id="popup-word"></h3>
            <button class="popup-close" onclick="closeWordPopup()">√ó</button>
        </div>
        <div id="popup-content"></div>
    </div>
    
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>Settings</h2>
            <div class="settings-section">
                <h3>Theme</h3>
                <div class="theme-switch-wrapper">
                    <span>üåû Light</span>
                    <label class="theme-switch" for="theme-checkbox">
                        <input type="checkbox" id="theme-checkbox" style="display:none;"/>
                        <div style="position:relative; display:inline-block; width:50px; height:28px; background-color:#ccc; border-radius:34px; cursor:pointer;">
                            <div style="position:absolute; height:20px; width:20px; left:4px; bottom:4px; background-color:white; border-radius:50%; transition: .4s;" id="theme-slider"></div>
                        </div>
                    </label>
                    <span>üåô Dark</span>
                </div>
            </div>
            <div class="settings-section">
                <h3>Voice Preference</h3>
                <div class="voice-select-wrapper">
                    <label for="voice-select">Speaker:</label>
                    <select id="voice-select" class="level-select-dropdown"></select>
                </div>
            </div>
        </div>
    </div>

<script>
    let articles = [];
    let currentArticleIndex = 0;
    let germanVoices = [];
    let currentUtterance = null;


    // ===================================================================================
    // 1. DICTIONARY SERVICE
    // ===================================================================================
    class DictionaryService {
        constructor() { this.cache = new Map(); }
        async getDefinition(word) {
            const cleanWord = word.toLowerCase().trim();
            if (this.cache.has(cleanWord)) return this.cache.get(cleanWord);
            
            try {
                // NOTE: This will fail when run locally due to CORS policy.
                // It will work when deployed to a web server.
                const url = `https://api.dictionaryapi.dev/api/v2/entries/de/${encodeURIComponent(cleanWord)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const data = await response.json();

                if (data.title === "No Definitions Found") {
                     throw new Error(`No definition found for ${word}`);
                }

                const firstMeaning = data[0]?.meanings[0];
                const definition = firstMeaning?.definitions[0]?.definition || 'No definition found.';
                const example = firstMeaning?.definitions[0]?.example || 'No example available.';

                const result = {
                    word,
                    definition: `${definition}<br><br><em>Example: ${example}</em>`,
                };
                this.cache.set(cleanWord, result);
                return result;
            } catch (error) {
                console.warn('Dictionary API failed:', error);
                const fallback = { word, definition: `Definition for <strong>${word}</strong> not available.` };
                this.cache.set(cleanWord, fallback);
                return fallback;
            }
        }
    }
    const dictionaryService = new DictionaryService();

    // ===================================================================================
    // 2. PROGRESS TRACKING
    // ===================================================================================
    function initializeProgressTracking() {
        window.userProgress = loadProgress();
        trackPageView();
    }

    function loadProgress() {
        try {
            const saved = localStorage.getItem('germanMasteryProgress');
            if (saved) {
                const parsed = JSON.parse(saved);
                return { ...parsed, articlesRead: new Set(parsed.articlesRead || []), vocabularyLearned: new Map(parsed.vocabularyLearned || []) };
            }
        } catch (error) { console.error('Failed to load progress:', error); }
        return { articlesRead: new Set(), vocabularyLearned: new Map(), streak: 0, lastVisit: null };
    }

    function saveProgress() {
        try {
            const progressData = { ...window.userProgress, articlesRead: Array.from(window.userProgress.articlesRead), vocabularyLearned: Array.from(window.userProgress.vocabularyLearned.entries()) };
            localStorage.setItem('germanMasteryProgress', JSON.stringify(progressData));
        } catch (error) { console.error('Failed to save progress:', error); }
    }

    function trackArticleRead(articleIndex) {
        if (!window.userProgress.articlesRead.has(articleIndex)) {
            window.userProgress.articlesRead.add(articleIndex);
            saveProgress();
        }
    }

    function trackVocabularyInteraction(word) {
        const current = window.userProgress.vocabularyLearned.get(word) || 0;
        window.userProgress.vocabularyLearned.set(word, current + 1);
        saveProgress();
    }

    function trackPageView() {
        const today = new Date().toDateString();
        if (window.userProgress.lastVisit !== today) {
            const yesterday = new Date(Date.now() - 864e5).toDateString();
            window.userProgress.streak = (window.userProgress.lastVisit === yesterday) ? (window.userProgress.streak || 0) + 1 : 1;
            window.userProgress.lastVisit = today;
            saveProgress();
        }
    }

    // ===================================================================================
    // 3. DATA FETCHING & PARSING (NOW FROM GOOGLE SHEETS)
    // ===================================================================================
    async function loadArticlesFromSheet(sheetUrl) {
        try {
            const response = await fetch(sheetUrl);
            if (!response.ok) {
                throw new Error(`Could not fetch sheet. Status: ${response.status}`);
            }
            const csvText = await response.text();
            
            // Basic CSV parser
            const rows = csvText.split(/\r?\n/).map(row => row.split(','));
            const headers = rows[0].map(h => h.trim());
            
            const jsonData = rows.slice(1).map(row => {
                let obj = {};
                headers.forEach((header, i) => {
                    obj[header] = row[i] ? row[i].replace(/"/g, '') : '';
                });
                return obj;
            });

            return jsonData.filter(article => article.STATUS === 'Published');
        } catch (error) {
            console.error('Failed to load articles from Google Sheet:', error);
            document.getElementById('article-selection-card').innerHTML = '<h2>Error</h2><p>Could not load articles from the source. Please check the console for details.</p>';
            return []; // Return empty array on failure
        }
    }


    // ===================================================================================
    // 4. UI DISPLAY & INTERACTION
    // ===================================================================================
    function setupLevelInteraction() {
        const container = document.getElementById('article-selection-card');
        if (!container || articles.length === 0) {
            container.innerHTML = '<h2>No Articles Found</h2><p>No published articles could be loaded. Please check your Google Sheet configuration.</p>';
            return;
        }

        container.innerHTML = `
            <h2>German Articles by Level</h2>
            <div class="level-selector-wrapper">
                <label for="level-select">Select a Level:</label>
                <select id="level-select" class="level-select-dropdown"></select>
            </div>
            <div id="article-list-container"></div>
        `;

        const levelSelect = document.getElementById('level-select');
        const articleListContainer = document.getElementById('article-list-container');

        const levels = [...new Set(articles.map(a => a.LEVEL))];
        
        levels.forEach(level => {
            const option = document.createElement('option');
            option.value = level;
            option.textContent = level;
            levelSelect.appendChild(option);
        });

        const displayArticlesForLevel = (level) => {
            const filteredArticles = articles.filter(a => a.LEVEL === level);
            articleListContainer.innerHTML = filteredArticles.map(article => {
                const globalIndex = articles.indexOf(article);
                return `<button class="article-theme-button" onclick='showArticle(${globalIndex})'>${article.THEME}</button>`;
            }).join('');
        };

        levelSelect.addEventListener('change', (e) => {
            displayArticlesForLevel(e.target.value);
        });

        if (levels.length > 0) {
            displayArticlesForLevel(levels[0]);
        }
    }

    function showArticle(index) {
        currentArticleIndex = index;
        const article = articles[index];
        if (!article) return;

        const articleDisplay = document.getElementById('article-display');
        document.getElementById('article-selection-card').style.display = 'none';
        articleDisplay.style.display = 'block';
        
        const coloredText = article.GERMAN_ARTICLE;
        
        const colorMap = [
            { name: 'Noun (der)', color: 'var(--noun-m)' },
            { name: 'Noun (die)', color: 'var(--noun-f)' },
            { name: 'Noun (das)', color: 'var(--noun-n)' },
            { name: 'Verb', color: 'var(--verb)' },
            { name: 'Adjective', color: 'var(--adjective)' },
            { name: 'Adverb', color: 'var(--adverb)' },
            { name: 'Preposition', color: 'var(--preposition)' },
            { name: 'Conjunction', color: 'var(--conjunction)' },
            { name: 'Pronoun', color: 'var(--pronoun)' },
            { name: 'Article', color: 'var(--article)' },
        ];

        articleDisplay.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>${article.THEME} (${article.LEVEL})</h2>
                <button class="btn btn-primary" onclick="backToList()">Back to List</button>
            </div>
            
            <div class="article-section">
                <h3>Deutscher Text</h3>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                     <button id="play-pause-btn" class="btn">‚ñ∂Ô∏è Play</button>
                </div>
                <details class="color-legend-details">
                    <summary>Show/Hide Color Legend</summary>
                    <div class="color-legend">
                        <div class="legend-grid">
                            ${colorMap.map(item => `
                                <div class="legend-item">
                                    <div class="legend-color-box" style="background-color: ${item.color};"></div>
                                    <span>${item.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </details>
                <div class="german-text">${coloredText}</div>
                <p><strong>Kurze Lektion:</strong> ${article.GRAMMAR_LESSON || 'N/A'}</p>
            </div>

            <div class="article-section translation-section">
                <h3>English Translation</h3>
                <p>${article.ENGLISH_TRANSLATION || 'N/A'}</p>
            </div>

            <div class="article-section vocabulary-section">
                <h3>Vocabulary</h3>
                <div>${article.VOCABULARY_USED || 'N/A'}</div>
            </div>

            <div class="article-section grammar-section">
                <h3>Deep Dive Grammar</h3>
                <div>${article.DEEP_DIVE_GRAMMAR || 'N/A'}</div>
                <p style="margin-top: 15px;"><strong>Tags:</strong> <small>${article.GRAMMAR_TOPIC_TAGS || 'N/A'}</small></p>
            </div>

            <div class="article-section culture-section">
                <h3>Phrases, Idioms, Quotes & Jokes</h3>
                <p>${article.PHRASE_AND_IDIOM || 'N/A'}</p>
                <p style="margin-top: 10px;">${article.QUOTE_AND_JOKE || 'N/A'}</p>
            </div>
            
            <div class="article-section">
                <h3>Conversation Time</h3>
                <div>${article.CONVERSATION_TIME || 'N/A'}</div>
            </div>

            <button class="btn btn-primary" onclick="backToList()" style="margin-top: 20px;">Back to List</button>
        `;

        document.getElementById('play-pause-btn').addEventListener('click', function() {
            togglePlayback(this);
        });

        trackArticleRead(index);
        setupGrammarDrill(article.DRILL_SENTENCES, article.THEME);
    }
    
    function backToList() {
        speechSynthesis.cancel(); // Stop any speech when going back
        document.getElementById('article-display').style.display = 'none';
        document.getElementById('article-selection-card').style.display = 'block';
    }

    async function showWordInfo(word, baseForm = word) {
        trackVocabularyInteraction(word);
        const popup = document.getElementById('word-popup');
        const backdrop = document.getElementById('word-popup-backdrop');
        document.getElementById('popup-word').textContent = word;
        const contentEl = document.getElementById('popup-content');
        contentEl.innerHTML = 'Loading...';

        popup.style.display = 'block';
        backdrop.style.display = 'block';

        const data = await dictionaryService.getDefinition(baseForm);
        let html = `<p><strong>Definition:</strong> ${data.definition}</p>`;
        
        const allSpans = document.querySelectorAll('.german-text span');
        const matchingSpan = Array.from(allSpans).find(span => span.textContent.trim() === word.trim() && span.classList.contains('verb'));
        
        if(matchingSpan) {
            html += getVerbConjugationTable(baseForm);
        }

        contentEl.innerHTML = html;
    }
    
    function getVerbConjugationTable(verb) {
        const verbData = getVerbData(verb);
        if (!verbData) return '';
        const { stem, pastStem, participle, auxiliary } = verbData;

        const present = { ich: stem + 'e', du: stem + 'st', er: stem + 't', wir: verb, ihr: stem + 't', sie: verb };
        const past = { ich: pastStem + 'te', du: pastStem + 'test', er: pastStem + 'te', wir: pastStem + 'ten', ihr: pastStem + 'tet', sie: pastStem + 'ten' };
        
        let perfectAux = auxiliary === 'sein' ? { ich: 'bin', du: 'bist', er: 'ist', wir: 'sind', ihr: 'seid', sie: 'sind' } : { ich: 'habe', du: 'hast', er: 'hat', wir: 'haben', ihr: 'habt', sie: 'haben' };
        let pluperfectAux = auxiliary === 'sein' ? { ich: 'war', du: 'warst', er: 'war', wir: 'waren', ihr: 'wart', sie: 'waren' } : { ich: 'hatte', du: 'hattest', er: 'hatte', wir: 'hatten', ihr: 'hattet', sie: 'hatten' };
        let futureAux = { ich: 'werde', du: 'wirst', er: 'wird', wir: 'werden', ihr: 'werdet', sie: 'werden' };
        
        return `
            <h4>Conjugations</h4>
            <table class="conjugation-table">
                <tr><th>Pronoun</th><th>Present</th><th>Past</th><th>Perfect</th><th>Pluperfect</th><th>Future I</th></tr>
                <tr><td>ich</td><td>${present.ich}</td><td>${past.ich}</td><td>${perfectAux.ich} ${participle}</td><td>${pluperfectAux.ich} ${participle}</td><td>${futureAux.ich} ${verb}</td></tr>
                <tr><td>du</td><td>${present.du}</td><td>${past.du}</td><td>${perfectAux.du} ${participle}</td><td>${pluperfectAux.du} ${participle}</td><td>${futureAux.du} ${verb}</td></tr>
                <tr><td>er/sie/es</td><td>${present.er}</td><td>${past.er}</td><td>${perfectAux.er} ${participle}</td><td>${pluperfectAux.er} ${participle}</td><td>${futureAux.er} ${verb}</td></tr>
                <tr><td>wir</td><td>${present.wir}</td><td>${past.wir}</td><td>${perfectAux.wir} ${participle}</td><td>${pluperfectAux.wir} ${participle}</td><td>${futureAux.wir} ${verb}</td></tr>
                <tr><td>ihr</td><td>${present.ihr}</td><td>${past.ihr}</td><td>${perfectAux.ihr} ${participle}</td><td>${pluperfectAux.ihr} ${participle}</td><td>${futureAux.ihr} ${verb}</td></tr>
                <tr><td>sie/Sie</td><td>${present.sie}</td><td>${past.sie}</td><td>${perfectAux.sie} ${participle}</td><td>${pluperfectAux.sie} ${participle}</td><td>${futureAux.sie} ${verb}</td></tr>
            </table>
        `;
    }

    function getVerbData(verb) {
        const irregulars = {
            'sein': { stem: 'sei', pastStem: 'war', participle: 'gewesen', auxiliary: 'sein' },
            'haben': { stem: 'hab', pastStem: 'hatte', participle: 'gehabt', auxiliary: 'haben' },
            'gehen': { stem: 'geh', pastStem: 'ging', participle: 'gegangen', auxiliary: 'sein' },
            'lesen': { stem: 'les', pastStem: 'las', participle: 'gelesen', auxiliary: 'haben' },
            'stehen': { stem: 'steh', pastStem: 'stand', participle: 'gestanden', auxiliary: 'haben' },
            'arbeiten': { stem: 'arbeit', pastStem: 'arbeitete', participle: 'gearbeitet', auxiliary: 'haben' },
            'ver√§ndern': { stem: 'ver√§nder', pastStem: 'ver√§nderte', participle: 'ver√§ndert', auxiliary: 'haben' },
            'schaffen': { stem: 'schaff', pastStem: 'schuf', participle: 'geschaffen', auxiliary: 'haben' },
        };
        if (irregulars[verb]) return irregulars[verb];

        const stem = verb.endsWith('en') ? verb.slice(0, -2) : verb.slice(0, -1);
        const participle = 'ge' + stem + 't';
        const auxiliary = 'haben'; 
        return { stem, pastStem: stem, participle, auxiliary };
    }

    function closeWordPopup() {
        document.getElementById('word-popup').style.display = 'none';
        document.getElementById('word-popup-backdrop').style.display = 'none';
    }
    
    // ===================================================================================
    // 5. GRAMMAR DRILL & AUDIO
    // ===================================================================================
    function togglePlayback(button) {
        if (speechSynthesis.speaking && !speechSynthesis.paused) {
            speechSynthesis.pause();
            button.textContent = '‚ñ∂Ô∏è Resume';
        } else if (speechSynthesis.paused) {
            speechSynthesis.resume();
            button.textContent = '‚è∏Ô∏è Pause';
        } else {
            const germanTextElement = button.closest('.article-section').querySelector('.german-text');
            if (!germanTextElement) return;

            const textToSpeak = germanTextElement.textContent || germanTextElement.innerText;
            
            currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            currentUtterance.lang = 'de-DE';
            currentUtterance.rate = 0.9;

            const savedVoiceName = getSettings().voice;
            const selectedVoice = germanVoices.find(voice => voice.name === savedVoiceName);
            currentUtterance.voice = selectedVoice || germanVoices[0] || null;

            currentUtterance.onend = () => {
                button.textContent = '‚ñ∂Ô∏è Play';
                currentUtterance = null;
            };
            currentUtterance.onerror = () => {
                button.textContent = '‚ñ∂Ô∏è Play';
                currentUtterance = null;
            };

            speechSynthesis.speak(currentUtterance);
            button.textContent = '‚è∏Ô∏è Pause';
        }
    }

    function setupGrammarDrill(drillSentences, theme) {
        const container = document.getElementById('grammar-drill-content');
        if (!drillSentences) {
            container.innerHTML = `<p>No grammar drills available for the article "${theme}". Please select another article.</p>`;
            return;
        }

        container.innerHTML = `<h3>Drills for: ${theme}</h3>`;
        const sentences = drillSentences.split('|');
        
        sentences.forEach((sentence, index) => {
            const match = sentence.match(/^(.*?)\{(.*?)\}(.*?)$/);
            if (!match) return;

            const [, part1, answer, part3] = match;
            const hint = answer.trim().charAt(0);
            
            const drillId = `drill-${currentArticleIndex}-${index}`;
            const inputId = `input-${drillId}`;
            const resultId = `result-${drillId}`;

            const item = document.createElement('div');
            item.className = 'drill-item';
            item.innerHTML = `
                <span>${part1.trim()}</span>
                <input type="text" id="${inputId}" data-answer="${answer.trim()}" placeholder="______" size="10">
                <span class="drill-hint" title="First letter of the answer">(${hint})</span>
                <span>${part3.trim()}</span>
                <button class="btn btn-primary">Check</button>
                <span class="drill-result" id="${resultId}"></span>
            `;
            
            container.appendChild(item);

            item.querySelector('button').addEventListener('click', () => {
                const input = document.getElementById(inputId);
                const result = document.getElementById(resultId);
                if (input.value.trim().toLowerCase() === input.dataset.answer.toLowerCase()) {
                    result.textContent = 'Correct!';
                    result.className = 'drill-result correct';
                    input.style.borderColor = 'var(--success)';
                } else {
                    result.textContent = `Incorrect. The answer is "${input.dataset.answer}".`;
                    result.className = 'drill-result incorrect';
                    input.style.borderColor = 'var(--danger)';
                }
            });
        });
    }


    // ===================================================================================
    // 6. SETTINGS & INITIALIZATION
    // ===================================================================================
    function populateVoiceList() {
        germanVoices = speechSynthesis.getVoices().filter(voice => voice.lang === 'de-DE');
        const voiceSelect = document.getElementById('voice-select');
        if (!voiceSelect) return;

        voiceSelect.innerHTML = '';
        const savedVoiceName = getSettings().voice;

        germanVoices.forEach(voice => {
            const option = document.createElement('option');
            option.textContent = voice.name;
            let gender = '';
            if (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('weiblich')) {
                gender = ' (Female)';
            } else if (voice.name.toLowerCase().includes('male') || voice.name.toLowerCase().includes('m√§nnlich')) {
                gender = ' (Male)';
            }
            option.textContent = `${voice.name.split(' ')[0]}${gender}`;
            option.value = voice.name;
            if (voice.name === savedVoiceName) {
                option.selected = true;
            }
            voiceSelect.appendChild(option);
        });
    }

    function setupSettings() {
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const themeToggle = document.getElementById('theme-checkbox');
        const themeSlider = document.getElementById('theme-slider');
        const voiceSelect = document.getElementById('voice-select');

        const settings = getSettings();
        document.body.classList.toggle('dark-theme', settings.theme === 'dark');
        themeToggle.checked = settings.theme === 'dark';
        themeSlider.style.transform = settings.theme === 'dark' ? 'translateX(22px)' : 'translateX(0)';

        settingsBtn.addEventListener('click', () => settingsModal.classList.add('visible'));
        settingsModal.querySelector('.modal-close-btn').addEventListener('click', () => settingsModal.classList.remove('visible'));
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) settingsModal.classList.remove('visible'); });
        
        themeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'light';
            document.body.classList.toggle('dark-theme', e.target.checked);
            themeSlider.style.transform = e.target.checked ? 'translateX(22px)' : 'translateX(0)';
            saveSettings({ theme });
        });

        voiceSelect.addEventListener('change', (e) => {
            saveSettings({ voice: e.target.value });
        });
    }

    function getSettings() {
        const defaults = { theme: 'light', voice: null };
        try {
            const storedSettings = JSON.parse(localStorage.getItem('germanAppSettings')) || {};
            return { ...defaults, ...storedSettings };
        } catch {
            return defaults;
        }
    }

    function saveSettings(newSettings) {
        const currentSettings = getSettings();
        localStorage.setItem('germanAppSettings', JSON.stringify({ ...currentSettings, ...newSettings }));
    }

    document.addEventListener('DOMContentLoaded', async () => {
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        // *** IMPORTANT: REPLACE WITH YOUR PUBLISHED GOOGLE SHEET URL ***
        const G_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT_b--q5fNfI2-3wQ1S5d1J0g8eP-5fNfI2-3wQ1S5d1J0g8e/pub?output=csv';
        
        articles = await loadArticlesFromSheet(G_SHEET_URL);
        
        setupLevelInteraction();
        initializeProgressTracking();
        setupSettings();

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                if (e.target.dataset.page) {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(e.target.dataset.page).classList.add('active');
                }
            });
        });
    });
</script>

</body>
</html>
