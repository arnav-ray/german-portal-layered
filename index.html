<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily German Learning</title>
    <meta name="description" content="Master German with themed articles, vocabulary, and real-world scenarios">
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-color: #f8f9fa;
            --card-bg-color: white;
            --text-color: #333;
            --header-text-color: #2c3e50;
            --subtle-text-color: #6c757d;
            --border-color: #dee2e6;
            --shadow-color: rgba(0,0,0,0.05);
            --primary-accent: #007bff;
        }

        body.dark-theme {
            --bg-color: #121212;
            --card-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --header-text-color: #ffffff;
            --subtle-text-color: #adb5bd;
            --border-color: #444;
            --shadow-color: rgba(0,0,0,0.2);
        }
        /* --- End Theming Variables --- */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--card-bg-color);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 {
            color: var(--header-text-color);
            font-size: 2em;
            margin: 0;
            text-align: left;
            flex-grow: 1;
        }

        header p {
            color: var(--subtle-text-color);
            font-size: 1.1em;
            width: 100%;
            text-align: center;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-select-dropdown {
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg-color);
            color: var(--text-color);
            font-family: 'Georgia', serif;
            font-size: 14px;
            cursor: pointer;
            min-width: 180px;
        }

        /* --- Theme Switch Styles --- */
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; }
        .theme-switch-wrapper span { font-size: 14px; color: var(--subtle-text-color); }
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-accent); }
        input:checked + .slider:before { transform: translateX(22px); }
        /* --- End Theme Switch Styles --- */

        .search-container { margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px 20px; border: 1px solid var(--border-color); background-color: var(--card-bg-color); color: var(--text-color); border-radius: 25px; font-size: 16px; transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--primary-accent); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }

        #article-display { background: var(--card-bg-color); padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px var(--shadow-color); }
        .german-text { font-size: 18px; line-height: 1.8; margin-bottom: 30px; padding: 20px; background: var(--bg-color); border-left: 4px solid var(--primary-accent); border-radius: 5px; }
        .english-text { font-size: 16px; color: var(--subtle-text-color); font-style: italic; margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107; }
        body.dark-theme .english-text { background: #3e3829; }

        /* --- Grammar Color Coding --- */
        .german-text span { cursor: pointer; transition: background-color 0.2s ease-in-out; padding: 1px 2px; border-radius: 3px; }
        .german-text span:hover { background-color: #d0eaff; }
        body.dark-theme .german-text span:hover { background-color: #003c7a; }

        .noun-m { color: #007bff; font-weight: bold; } .noun-f { color: #dc3545; font-weight: bold; } .noun-n { color: #28a745; font-weight: bold; }
        .verb { color: #6f42c1; text-decoration: underline; } .adjective { color: #fd7e14; } .adverb { color: #6c757d; font-style: italic; }
        .preposition { color: #E91E63; } .conjunction { color: #20c997; } .pronoun { color: #ffc107; } .article { color: #17a2b8; font-weight: bold; }
        .punctuation { color: var(--subtle-text-color); }
        /* --- End Grammar Coding --- */

        .vocabulary-section, .phrases-section, .quotes-section, .conversation-section { margin-top: 20px; padding: 15px; border-radius: 8px; border-left: 4px solid transparent; }
        .vocabulary-section { background-color: #e8f4fd; border-left-color: #007bff; }
        .phrases-section { background-color: #e8f5e8; border-left-color: #28a745; }
        .quotes-section { background-color: #fff5e6; border-left-color: #fd7e14; font-style: italic; }
        .conversation-section { background-color: #f8e6ff; border-left-color: #6f42c1; }

        body.dark-theme .vocabulary-section { background-color: #2a333d; }
        body.dark-theme .phrases-section { background-color: #2a352c; }
        body.dark-theme .quotes-section { background-color: #3e332a; }
        body.dark-theme .conversation-section { background-color: #342a3d; }

        .vocabulary-section strong, .phrases-section strong, .quotes-section strong, .conversation-section strong { display: block; margin-bottom: 8px; font-size: 16px; color: var(--header-text-color); }
        .vocabulary-section div, .phrases-section div, .quotes-section div, .conversation-section div { font-size: 15px; line-height: 1.5; }

        .nav-buttons { text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .nav-btn { display: inline-block; padding: 10px 20px; background: var(--primary-accent); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease; }
        .nav-btn:hover { background: #0056b3; }

        .metadata { background: var(--bg-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; border-left: 4px solid var(--subtle-text-color); }
        #loading { text-align: center; padding: 50px; font-size: 18px; color: var(--subtle-text-color); }
        #article-info { text-align: center; margin-top: 20px; }
        #article-info small { color: var(--subtle-text-color); font-size: 13px; }

        #audio-player-container { display: flex; gap: 10px; align-items: center; background-color: var(--bg-color); padding: 10px 15px; border-radius: 25px; margin-bottom: 20px; width: fit-content; }
        .audio-btn { background: var(--primary-accent); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
        .audio-btn:hover { background: #0056b3; }
        #audio-status { font-size: 14px; color: var(--subtle-text-color); font-weight: bold; }

        .error-message { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; margin: 20px 0; border-radius: 8px; text-align: center; }
        body.dark-theme .error-message { background-color: #4a2c2c; border-color: #dc3545; color: #f8d7da; }

        /* --- UPDATED: Mobile Responsive Styles --- */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .header-top { 
                flex-direction: column; 
                text-align: center; 
                justify-content: center;
            }
            header h1 { 
                text-align: center;
                font-size: 1.8em;
                margin-bottom: 10px;
            }
            .nav-buttons { 
                flex-direction: column; 
                align-items: center; 
            }
            .nav-btn { 
                width: 100%; 
                max-width: 280px; 
            }
            #article-display {
                padding: 15px;
            }
            .german-text {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>Daily German Learning</h1>
                <div class="header-controls">
                    <nav id="theme-nav">
                        <select id="theme-select" class="theme-select-dropdown">
                            <option value="">Browse by Theme</option>
                        </select>
                    </nav>
                    <div class="theme-switch-wrapper">
                        <span>üåû</span>
                        <label class="theme-switch" for="theme-checkbox">
                            <input type="checkbox" id="theme-checkbox" />
                            <div class="slider"></div>
                        </label>
                        <span>üåô</span>
                    </div>
                </div>
            </div>
            <p>Master German with themed articles and real-world scenarios</p>
        </header>
        
        <div class="search-container" id="search-container" style="display: none;">
            <input 
                type="text" 
                id="search-input" 
                class="search-input" 
                placeholder="Search articles, themes, or vocabulary..."
            >
        </div>
        
        <main id="main-content">
            <div id="loading">Loading today's article...</div>
            <div id="article-display" style="display: none;"></div>
        </main>
        
        <div class="nav-buttons" id="nav-buttons" style="display: none;">
            <button class="nav-btn" onclick="navigateArticle('previous')">‚Üê Previous Article</button>
            <button class="nav-btn" onclick="resetSearch()">üîÑ Show All / Latest</button>
            <button class="nav-btn" onclick="navigateArticle('next')">Next Article ‚Üí</button>
        </div>
        
        <div id="article-info" style="display: none;">
            <p><small>Article <span id="current-article-number">1</span> of <span id="total-articles">0</span> | 
            <span id="current-date"></span></small></p>
        </div>
    </div>
    
    <script>
        const SHEET_ID = '1WbU27bSvjaHWCdCl7deU9-iEBTCmlSZe8l99-ppxfS8';
        const SHEET_NAME = 'Sheet1';
        const API_KEY = 'AIzaSyBjd0EF0ghF3hZdpB-0wSbeEBkrSDhG1J8';

        let articles = [];
        let filteredArticles = [];
        let currentArticle = null;
        const synth = window.speechSynthesis;

        const themeToggle = document.getElementById('theme-checkbox');
        
        function initializeTheme() {
            const currentTheme = localStorage.getItem('theme') || 'light-theme';
            if (currentTheme === 'dark-theme') {
                document.body.classList.add('dark-theme');
                themeToggle.checked = true;
            }
        }

        function setupThemeToggle() {
            if (themeToggle) {
                themeToggle.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-theme');
                        localStorage.setItem('theme', 'dark-theme');
                    } else {
                        document.body.classList.remove('dark-theme');
                        localStorage.setItem('theme', 'light-theme');
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            setupThemeToggle();
            setupSearchInput();
            loadArticles();
        });

        function setupSearchInput() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        searchArticles(this.value);
                    }
                });
            }
        }

        async function loadArticles() {
            document.getElementById('loading').style.display = 'block';
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = errorData.error?.message || `API request failed with status ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                if (!data.values || data.values.length < 2) {
                    throw new Error('No data found in the sheet or sheet is empty.');
                }
                
                articles = parseSheetData(data.values);
                if (articles.length > 0) {
                    filteredArticles = [...articles];
                    displayLatestArticle();
                    setupThemeNavigation();
                    setupUI();
                } else {
                    throw new Error('No "Published" articles found in the sheet.');
                }
            } catch (error) {
                console.error('Error loading articles:', error);
                showError('Error loading content. Please check your API configuration.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function parseSheetData(rows) {
            const headers = rows[0].map(h => h.trim().replace(/\s/g, '_').replace(/&/g, 'and'));
            const data = [];
            const statusIndex = headers.indexOf('Status');

            for (let i = rows.length - 1; i > 0; i--) {
                const row = rows[i];
                if (row[statusIndex] && row[statusIndex].trim() === 'Published') {
                    let article = {};
                    headers.forEach((header, index) => {
                        article[header] = row[index] || '';
                    });
                    data.push(article);
                }
            }
            return data;
        }

        function displayLatestArticle() {
            if (articles.length > 0) {
                displayArticle(articles[0]);
            }
        }

        function displayArticle(article) {
            currentArticle = article;
            synth.cancel();
            const displayContainer = document.getElementById('article-display');
            
            const safeGet = (field, fallback = '') => article[field] || fallback;

            const displayHTML = `
                <div id="audio-player-container"></div>
                <div class="metadata">
                    <strong>Theme:</strong> ${safeGet('THEME')} | 
                    <strong>Grammar Focus:</strong> ${safeGet('GRAMMAR_LESSON').replace(/\n/g, '<br>')} |
                    <strong>Date:</strong> ${safeGet('DATE')}
                </div>
                <div class="german-text">${safeGet('GERMAN_ARTICLE')}</div>
                <div class="english-text">${safeGet('ENGLISH_TRANSLATION').replace(/\n/g, '<br>')}</div>
                <div class="vocabulary-section"><strong>üéØ Key Vocabulary:</strong><div>${safeGet('VOCABULARY_USED')}</div></div>
                <div class="phrases-section"><strong>üí¨ Phrases & Idioms:</strong><div>${safeGet('PHRASE_and_IDIOM').replace(/\n/g, '<br>')}</div></div>
                <div class="quotes-section"><strong>üòÑ Quote & Joke:</strong><div>${safeGet('QUOTE_and_JOKE').replace(/\n/g, '<br>')}</div></div>
                <div class="conversation-section"><strong>üó£Ô∏è Conversation Time:</strong><div>${safeGet('CONVERSATION_TIME').replace(/\n/g, '<br>')}</div></div>
            `;
            
            displayContainer.innerHTML = displayHTML;
            displayContainer.style.display = 'block';
            
            setupAudioPlayer();
            updateArticleCounter();
        }
        
        function setupAudioPlayer() {
            const audioContainer = document.getElementById('audio-player-container');
            if (!audioContainer || !'speechSynthesis' in window) {
                if(audioContainer) audioContainer.style.display = 'none';
                return;
            }

            audioContainer.innerHTML = `
                <button id="play-pause-btn" class="audio-btn" title="Play/Pause">‚ñ∂Ô∏è</button>
                <button id="stop-btn" class="audio-btn" title="Stop">‚èπÔ∏è</button>
                <span id="audio-status">Read Aloud</span>
            `;

            const playPauseBtn = document.getElementById('play-pause-btn');
            const stopBtn = document.getElementById('stop-btn');
            const statusLabel = document.getElementById('audio-status');
            const germanTextElement = document.querySelector('.german-text');
            const textToSpeak = germanTextElement ? (germanTextElement.textContent || "") : "";

            playPauseBtn.onclick = () => {
                if (synth.speaking && !synth.paused) {
                    synth.pause();
                } else if (synth.paused) {
                    synth.resume();
                } else {
                    if (!textToSpeak) return;
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'de-DE';
                    utterance.rate = 0.9;
                    utterance.onstart = () => {
                        playPauseBtn.textContent = '‚è∏Ô∏è';
                        statusLabel.textContent = 'Playing...';
                    };
                    utterance.onpause = () => {
                        playPauseBtn.textContent = '‚ñ∂Ô∏è';
                        statusLabel.textContent = 'Paused';
                    };
                    utterance.onresume = () => {
                        playPauseBtn.textContent = '‚è∏Ô∏è';
                        statusLabel.textContent = 'Playing...';
                    };
                    utterance.onend = () => {
                        playPauseBtn.textContent = '‚ñ∂Ô∏è';
                        statusLabel.textContent = 'Read Aloud';
                    };
                    synth.speak(utterance);
                }
            };

            stopBtn.onclick = () => {
                synth.cancel();
                playPauseBtn.textContent = '‚ñ∂Ô∏è';
                statusLabel.textContent = 'Read Aloud';
            };
        }

        function showError(message) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `<div class="error-message">${message}</div>`;
            mainContent.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function setupUI() {
            document.getElementById('search-container').style.display = 'block';
            document.getElementById('nav-buttons').style.display = 'block';
            document.getElementById('article-info').style.display = 'block';
        }

        function setupThemeNavigation() {
            const themeSelect = document.getElementById('theme-select');
            const themes = [...new Set(articles.map(article => article.THEME))];
            
            themeSelect.innerHTML = '<option value="">Browse by Theme</option>';
            
            themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme;
                option.textContent = theme;
                themeSelect.appendChild(option);
            });

            themeSelect.addEventListener('change', function() {
                showArticlesByTheme(this.value);
            });
        }

        function showArticlesByTheme(theme) {
            if (!theme) {
                resetSearch();
                return;
            }
            filteredArticles = articles.filter(article => article.THEME === theme);
            if (filteredArticles.length > 0) {
                displayArticle(filteredArticles[0]);
            }
        }

        function navigateArticle(direction) {
            const currentIndex = filteredArticles.findIndex(a => a.DATE === currentArticle.DATE && a.THEME === currentArticle.THEME);
            if (currentIndex === -1) return;

            let newIndex;
            if (direction === 'next') {
                newIndex = (currentIndex - 1 + filteredArticles.length) % filteredArticles.length;
            } else {
                newIndex = (currentIndex + 1) % filteredArticles.length;
            }
            displayArticle(filteredArticles[newIndex]);
        }

        function searchArticles(keyword) {
            const searchInput = document.getElementById('search-input');
            const searchTerm = keyword || searchInput.value;
            if (!searchTerm.trim()) {
                resetSearch();
                return;
            }
            
            const searchResults = articles.filter(article => 
                Object.values(article).some(value => String(value).toLowerCase().includes(searchTerm.toLowerCase()))
            );
            
            if (searchResults.length > 0) {
                filteredArticles = searchResults;
                displayArticle(searchResults[0]);
                showSearchResults(searchResults.length, searchTerm);
            } else {
                alert(`No articles found for "${searchTerm}"`);
            }
        }

        function showSearchResults(count, keyword) {
            const metadata = document.querySelector('.metadata');
            if (metadata) {
                const existingSearch = document.querySelector('.search-results');
                if (existingSearch) existingSearch.remove();

                const searchInfo = document.createElement('div');
                searchInfo.className = 'search-results';
                searchInfo.innerHTML = `<small>üîç Found ${count} result(s) for "${keyword}" | <a href="#" onclick="event.preventDefault(); resetSearch();">Show all articles</a></small>`;
                metadata.insertAdjacentElement('afterend', searchInfo);
            }
        }

        function resetSearch() {
            filteredArticles = [...articles];
            displayLatestArticle();
            const searchResults = document.querySelector('.search-results');
            if (searchResults) searchResults.remove();
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) themeSelect.value = '';
        }

        function updateArticleCounter() {
            const currentIndex = filteredArticles.findIndex(a => a.DATE === currentArticle.DATE && a.THEME === currentArticle.THEME);
            document.getElementById('current-article-number').textContent = currentIndex + 1;
            document.getElementById('total-articles').textContent = filteredArticles.length;
            document.getElementById('current-date').textContent = currentArticle.DATE;
        }

        document.addEventListener('keydown', function(event) {
            const searchInput = document.getElementById('search-input');
            if (document.activeElement !== searchInput) {
                if (event.key === 'ArrowLeft') navigateArticle('previous');
                if (event.key === 'ArrowRight') navigateArticle('next');
                if (event.key === 'Home') {
                    event.preventDefault();
                    resetSearch();
                }
            }
        });
    </script>
</body>
</html>
